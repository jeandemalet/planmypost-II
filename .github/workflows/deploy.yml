name: Deploy to VM

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual deployment
    inputs:
      force_reload:
        description: 'Force PM2 reload (instead of graceful)'
        required: false
        default: 'false'
        type: boolean

jobs:
  deploy:
    name: Deploy code to planmypost-vm
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      # Ã‰TAPE 1 : CONNEXION AU RÃ‰SEAU TAILSCALE
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}

      # Ã‰TAPE 1.5 : PAUSE POUR STABILISER LE RÃ‰SEAU
      - name: Wait for Tailscale
        run: sleep 5

      # Ã‰TAPE 2 : DÃ‰PLOIEMENT VIA SSH AVEC ZERO-DOWNTIME
      - name: SSH into VM and deploy with zero-downtime
        uses: appleboy/ssh-action@master
        with:
          # On utilise l'adresse IP, c'est le plus fiable
          host: 100.77.241.100
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting zero-downtime deployment..."
            
            # VÃ©rifier si nous sommes dans le bon rÃ©pertoire
            cd /var/www/planmypost-II || {
              echo "âŒ Failed to change to deployment directory"
              exit 1
            }
            
            # Sauvegarder l'Ã©tat actuel au cas oÃ¹ nous devons faire un rollback
            echo "ğŸ“‹ Creating backup point..."
            BACKUP_BRANCH="backup-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BACKUP_BRANCH" 2>/dev/null || true
            git checkout main
            
            # VÃ©rifier l'Ã©tat de PM2 avant le dÃ©ploiement
            echo "ğŸ“Š Checking PM2 status before deployment..."
            pm2 status
            
            # RÃ©cupÃ©rer les derniers changements
            echo "ğŸ“¥ Pulling latest changes..."
            git fetch origin main
            git reset --hard origin/main
            
            # VÃ©rifier et installer les nouvelles dÃ©pendances
            echo "ğŸ“¦ Checking for dependency updates..."
            if ! npm ci --production --silent; then
              echo "âŒ Failed to install dependencies"
              exit 1
            fi
            
            # Valider l'environnement avant le redÃ©marrage
            echo "ğŸ” Validating environment configuration..."
            if ! node -e "require('./config/environment').validateEnvironment()" 2>/dev/null; then
              echo "âš ï¸  Environment validation failed, but continuing..."
            fi
            
            # ExÃ©cuter les checks de sÃ©curitÃ© (non bloquant)
            echo "ğŸ”’ Running security checks..."
            npm run security:check || echo "âš ï¸  Security checks failed, but deployment continues"
            
            # RedÃ©marrage PM2 avec zÃ©ro downtime
            if [ "${{ github.event.inputs.force_reload }}" = "true" ]; then
              echo "ğŸ”„ Force reloading PM2 application..."
              pm2 reload ecosystem.config.js --env production --force
            else
              echo "ğŸ”„ Gracefully reloading PM2 application..."
              pm2 reload ecosystem.config.js --env production
            fi
            
            # Attendre que l'application soit stable
            echo "â³ Waiting for application to stabilize..."
            sleep 10
            
            # VÃ©rifier la santÃ© de l'application
            echo "ğŸ¥ Health check..."
            if pm2 status | grep -q "online"; then
              echo "âœ… Application is running successfully"
              
              # Test de base de l'API
              if curl -f http://localhost:3000/api/auth/status &>/dev/null; then
                echo "âœ… API health check passed"
              else
                echo "âš ï¸  API health check failed, but application is running"
              fi
              
              # Nettoyer les anciennes branches de backup (garder seulement les 5 derniÃ¨res)
              echo "ğŸ§¹ Cleaning up old backup branches..."
              git branch | grep "backup-" | head -n -5 | xargs -r git branch -D 2>/dev/null || true
              
              echo "ğŸ‰ Deployment successful!"
              
              # Afficher les informations de dÃ©ploiement
              echo "ğŸ“‹ Deployment Summary:"
              echo "   - Commit: $(git rev-parse --short HEAD)"
              echo "   - Deployed at: $(date)"
              echo "   - PM2 Status:"
              pm2 status
              
            else
              echo "âŒ Application failed to start properly"
              echo "ğŸ”™ Rolling back to previous state..."
              git checkout "$BACKUP_BRANCH"
              pm2 reload ecosystem.config.js --env production
              echo "ğŸ”„ Rollback completed"
              exit 1
            fi